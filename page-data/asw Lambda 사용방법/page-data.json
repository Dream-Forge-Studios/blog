{"componentChunkName":"component---src-templates-post-template-tsx","path":"/asw Lambda 사용방법/","result":{"data":{"allMarkdownRemark":{"edges":[{"node":{"html":"<br>\n<br>\n<p>저는 쿠팡 api로 가격데이터를 매일 가져와서 가격의 흐름을 확인할 수 있는 웹 서비스를 기획하고 있습니다.</p>\n<br>\n<p>그전에 로컬에서 해당 코드를 매일 실행시키는 것은 번거로운 과정이니, aws Lambda와 Amazon EventBridge를 통해 매일 일정한 시간에 api를 호출하여 s3에 엑셀 저장 및 RDS를 활용한 db 저장 기능을 구현해보려고 합니다.</p>\n<div id=\"aws Lambda란?\"></div>\n<h2>aws Lambda란?</h2>\n<p>Amazon Web Services(AWS)에서 제공하는 서버리스 컴퓨팅 서비스입니다. 이 서비스는 개발자가 서버 관리에 신경 쓰지 않고 코드 실행에 집중할 수 있게 해주는 플랫폼입니다.</p>\n<br>\n<p>코드를 업로드하고 실행 조건(트리거)을 설정하기만 하면 AWS가 나머지를 관리합니다.</p>\n<br>\n<p>사용한 컴퓨팅 자원에 대해서만 비용을 지불합니다. 요청 수와 실행 시간에 따라 요금이 책정되며, 코드가 실행되지 않을 때는 비용이 발생하지 않습니다.</p>\n<div id=\"사용 방법\"></div>\n<h2>사용 방법</h2>\n<p>aws Lambda 대시보드에서 함수를 생성하고 코드 입력창에 단순히 입력하고 Depoly하여 코드를 반영하고 Test를 하면 간단히 실행해볼 수 있습니다.</p>\n<br>\n<p><strong>라이브러리 추가</strong></p>\n<br>\n<p>코드를 추가하는 것은 어렵지 않으나, 라이브러리를 추가하는 경우 처음 접하는 사람에게는 어려울 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">#python 디렉토리 생성\r\nmkdir python\r\n\r\n# python 패키지 설치 (amazon linux 에서는 기본 pip 명령어가 python 2.X 이므로 pip3를 입력해야 함)\r\n$ pip3 install -t ./python pytz</code></pre></div>\n<p>위와 같이 AWS Lambda의 기본 환경에 이미 포함되어 있는 라이브러리 외 필요한 라이브러리를 python 디렉토리에 설치합니다.</p>\n<br>\n<p>한가지 주의해야할 점은 AWS Lambda 환경은 Linux 기반입니다. 그래서 pandas 같이 window, mac, linux 버전이 다른 라이브러리는 linux 버전 라이브러리를 설치해야합니다.</p>\n<br>\n<p>방법은 <a href=\"https://pypi.org/project/pandas/#files\" target=\"_blank\" rel=\"nofollow\">https://pypi.org/project/pandas/#files</a> 해당 링크에 들어가 자신의 버전에 맞는 파일을 다운로드 후 압축을 풀어 python 디렉토리에 넣어주면 됩니다.</p>\n<br>\n<p>또한 requests 라이브러리를 사용하는 과정에서 오류가 났는데 requests는</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ pip3 install -t ./python requests==2.29.0 urllib3==1.26.16</code></pre></div>\n<p>위와 같은 버전으로 설치해야 AWS Lambda의 환경에서 오류가 나지 않습니다.</p>\n<br>\n<p>이렇게 라이브러리 설치가 모두 끝났다면, python 디렉토리가 포함되도록 .zip으로 압축합니다.</p>\n<br>\n<p>압축한 파일은 Lambda > 계층 경로로 가 계층을 생성 후, 다시 함수 화면으로 가 Add a layer 해주면 됩니다.</p>\n<div id=\"S3 연결하기\"></div>\n<h2>S3 연결하기</h2>\n<p>AWS Lambda 함수에서 S3에 읽고 쓰기 권한을 가져오는 방법입니다.</p>\n<br>\n<p>Amazon S3에 버킷 생성 후 권한 탭의 버킷 정책에</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\r\n  \"Version\": \"2012-10-17\",\r\n  \"Statement\": [\r\n    {\r\n      \"Effect\": \"Allow\",\r\n      \"Principal\": {\r\n        \"AWS\": \"arn:aws:iam::123456789012:service-role/lambda-role\"\r\n      },\r\n      \"Action\": [\r\n        \"s3:GetObject\",\r\n        \"s3:PutObject\"\r\n      ],\r\n      \"Resource\": \"arn:aws:s3:::your-bucket-name/*\"\r\n    }\r\n  ]\r\n}</code></pre></div>\n<p>위와 같이 입력하면 됩니다.</p>\n<br>\n<p><code class=\"language-text\">123456789012</code> 부분은 AWS 계정 ID이며,</p>\n<p><code class=\"language-text\">lambda-role</code>은 함수 > 구성탭 > 권한의 역할 이름,</p>\n<p><code class=\"language-text\">your-bucket-name</code>은 대상 S3 버킷의 이름입니다.</p>\n<h2>Amazon RDS</h2>\n<p>Amazon RDS는 다양한 배포 옵션을 제공하여, 다양한 운영 요구 사항과 성능, 가용성, 비용에 따라 최적의 데이터베이스 솔루션을 선택할 수 있는 서비스입니다.</p>\n<br>\n<p>기본적인 사용 방법과 초기 개발을 위한 무료 사용 방법이 있습니다.</p>\n<br>\n<p>우선 기본적인 사용 방법은</p>\n<br>\n<p><strong>사용 방법</strong></p>\n<ol>\n<li>RDS > 데이터베이스 생성</li>\n<li>생성 옵션 설정\n<ul>\n<li>배포 옵션: 단일 DB 인스턴스 (비용 효율을 위해 선택, 다만 백업 및 재해 복구를 하지 못함)</li>\n<li>DB 인스턴스 클래스\n<ol>\n<li>스탠다드 클래스 (M 클래스 포함)</li>\n</ol>\n<ul>\n<li>특징: 스탠다드 클래스는 균형 잡힌 CPU와 메모리를 제공합니다. 일반적인 용도의 애플리케이션에 적합하며, 다양한 종류의 데이터베이스 워크로드에 폭넓게 사용됩니다.</li>\n<li>사용 사례: 웹 애플리케이션, 소규모/중간 규모의 데이터베이스, 개발 및 테스트 환경 등에 적합합니다.</li>\n</ul>\n<ol start=\"2\">\n<li>메모리 최적화 클래스 (R 및 X 클래스 포함)\n<ul>\n<li>특징: 메모리 최적화 클래스는 높은 메모리 용량과 더불어 빠른 CPU 성능을 제공합니다. 메모리 집약적인 애플리케이션에 적합하며, 대규모 데이터베이스 작업과 복잡한 쿼리 처리에 유리합니다.</li>\n<li>사용 사례: 대규모 트랜잭션 처리, 대규모 데이터베이스, 복잡한 쿼리가 많은 애플리케이션, 데이터 웨어하우징 등에 적합합니다.</li>\n</ul>\n</li>\n<li>버스터블 클래스 (T 클래스 포함)\n<ul>\n<li>특징: 버스터블 클래스는 평상시에는 제한된 CPU 성능을 제공하지만, 필요에 따라 CPU 성능을 일시적으로 늘릴 수 있는 “버스팅” 기능을 제공합니다. 가변적인 컴퓨팅 리소스가 필요한 경우에 적합합니다.</li>\n<li>사용 사례: 경량 또는 간헐적인 트래픽을 처리하는 애플리케이션, 개발 및 테스트 환경, 소규모 애플리케이션 등에 적합합니다.</li>\n</ul>\n</li>\n</ol>\n</li>\n<li>EC2 컴퓨팅 리소스에 연결해야하는 경우\n<ul>\n<li>직접 서버 관리 필요</li>\n</ul>\n</li>\n<li>퍼블릭 액세스\n<ul>\n<li>안과 데이터의 민감성을 고려할 때, 가능한 한 VPC 내부에서 Lambda 함수와 데이터베이스 간의 통신을 구성하는 것이 바람직합니다. 퍼블릭 액세스는 편리할 수 있지만, 보안 리스크를 증가시킬 수 있으므로 주의가 필요합니다. 실제 프로덕션 환경에서는 퍼블릭 액세스보다는 VPC 내부에서의 접근 방식을 선택하는 것이 일반적으로 더 안전합니다.</li>\n</ul>\n</li>\n<li>RDS Proxy\n<ul>\n<li>연결 풀링을 통해 데이터베이스 서버에 대한 부하를 줄이고, 연결 설정 및 종료로 인한 오버헤드를 감소시킵니다.</li>\n<li>데이터베이스 서버로의 트래픽을 조절하여 부하 분산을 제공합니다.</li>\n<li>데이터베이스 연결 중에 발생할 수 있는 장애를 자동으로 감지하고 복구합니다.</li>\n<li>그러나 추가 비용이 발생하기 때문에, Proxy 도입 전에 애플리케이션의 요구 사항과 비용 대비 이득을 충분히 고려해야 합니다.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<p><strong>무료로 사용하기</strong></p>\n<br>\n<p>무료로 사용하는 방법은 프리 티어로 선택하는 방법이다.</p>\n<br>\n<p>우선 프리 티어 설정이 가능한 엔진 옵션 선택하여 프리 티어 선택을 한다.</p>\n<br>\n<p>이렇게만 하면 무료로 사용된다고 생각할 수 있지만, 추가로 아래의 설정을 해줘야 완전한 무료이다.</p>\n<br>\n<ol>\n<li>DB 인스턴스 클래스: dn.t2.micro</li>\n<li>스토리지 자동 조정 활성화 off</li>\n<li>백업 보존 기간: 0days</li>\n<li>스토리지 사용량 20GiB 넘기지 않기</li>\n</ol>\n<p>이렇게 데이터베이스 생성을 마쳤으면, 한국에 맞추어 파라미터 그룹 생성 및 설정을 해주어야한다.</p>\n<br>\n<p><strong>파라미터 그룹</strong></p>\n<ol>\n<li>RDS > 파라미터 그룹 > 파라미터 그룹 생성</li>\n<li>작업 > 편집</li>\n<li>값 변경\n<ul>\n<li>timezone: Asia/Seoul</li>\n<li>character set: utf4mb4</li>\n<li>collation: utf8mb4_general_ci</li>\n</ul>\n</li>\n<li>RDS > 데이터베이스 > 수정</li>\n<li>DB 파라미터 그룹을 생성한 파리미터 그룹으로 설정</li>\n<li>즉시 적용 선택 후 수정 완료되면 재부팅</li>\n</ol>\n<p>이제 모든 설정을 맞췄으니 AWS RDS를 DBeaver에 연결해보자</p>\n<br>\n<p><strong>DBeaver에 연결</strong></p>\n<ul>\n<li>DBeaver란?</li>\n</ul>\n<p>다양한 데이터베이스 관리 시스템(DBMS)에 대해 통합 데이터베이스 관리 및 개발 도구를 제공하는 오픈 소스 소프트웨어입니다.</p>\n<br>\n<p><a href=\"https://dbeaver.io/download/\" target=\"_blank\" rel=\"nofollow\">https://dbeaver.io/download/</a> 해당 링크를 통해 설치할 수 있습니다.</p>\n<ul>\n<li>DBeaver에 연결하기</li>\n</ul>\n<ol>\n<li>우선 RDS 데이터베이스의 퍼블릭 엑세스를 예라고 설정한다.\n<ul>\n<li>실제 서비스를 할 때는 아니오로 설정해야한다.</li>\n<li>다만 아니오일 때 해당 데이터베이스의 접근하려면 복잡함으로 우선 개발을 마치기 전까지는 예로 설정한다.</li>\n</ul>\n</li>\n<li>VPC 보안 그룹 클릭 > 인바운드 규칙 편집 > 규칙 추가 > 내 IP\n<ul>\n<li>기본으로 냅두면 연결이 되지 않으니 수정해야한다.</li>\n</ul>\n</li>\n<li>DBeaver를 열고 좌측 상단에 콘센트 모양에 +가 붙어있는 아이콘을 선택한다.</li>\n</ol>\n<img style=\"width: 30%; margin-bottom: 40px;\" id=\"output\" src=\"https://velog.velcdn.com/cloudflare/shawnhansh/ff70b719-786a-4145-b33e-22d5ddad7657/4.png\">\n<img style=\"width: 80%; margin-bottom: 40px;\" id=\"output\" src=\"https://velog.velcdn.com/cloudflare/shawnhansh/b249e387-f40e-4d8c-9493-374788d5e7ad/image.png\">\n<img style=\"width: 80%; margin-bottom: 40px;\" id=\"output\" src=\"https://velog.velcdn.com/cloudflare/shawnhansh/281dca40-f36d-4238-9811-edc2b81244a4/7.png\">\n<ul>\n<li>Server Host : 엔드포인트</li>\n<li>Port : 포트</li>\n<li>Database : DB 이름 (초기 데이터베이스 이름 설정 하지 않았으면 비워둠)</li>\n<li>Username : 마스터 사용자 이름</li>\n<li>Password : 비밀번호</li>\n</ul>\n<br>\n<p><strong>Lambda에 연결</strong></p>\n<img style=\"width: 70%; margin-top: 40px;\" id=\"output\" src=\"/story/7a3367cf78d3d4f7b3e8f542f2a2a233/architecture.png\">\n<br>\n<p>이 부분에서 문제가 많았습니다.</p>\n<ol>\n<li>lambda가 RDS에 연결하기 위해서는 같은 VPC에 위치하여야 합니다.</li>\n<li>그런데 vpc에 lambda가 위치하면 외부 api를 호출할 수 없습니다.</li>\n<li>그래서 NAT instance를 만들어 이를 통해 외부 api를 호출하여야 합니다.</li>\n</ol>\n<br>\n<p>여러 시행착오 끝에 그림과 같은 구조로 해결하였습니다.</p>\n<br>\n<ul>\n<li>lambda에서 설정\n<ol>\n<li>IAM > 역할 > lambda 함수에 해당하는 역할명</li>\n<li>권한 추가: AWSLambdaVPCAccessExecutionRole (lambda에서 VPC를 사용가능하게 함)</li>\n<li>Lambda 함수 > 구성 > VPC 편집</li>\n<li>NAT instance와 연결된 서브넷 선택</li>\n<li>RDS와 동일한 보안 그룹 선택</li>\n</ol>\n</li>\n</ul>\n<div id=\"NAT Instance\"></div>\n<h2>NAT Instance</h2>\n<p>AWS에서 네트워크를 설계할때 NAT의 사용은 필수적입니다. VPC 내에서는 외부 인터넷 접속이 불가하기 때문입니다.</p>\n<br>\n<p>AWS에서 강력하게 밀어주는 최신식 NAT Gateway 서비스를 이용해서 손쉽게 사설망 외부 통신을 할 수 있지만, 비용 문제가 발생하므로 본 프로젝트에서는 NAT Instance를 사용합니다.</p>\n<br>\n<p>NAT 인스턴스는 EC2 인스턴스를 NAT용으로 설정해 사용하는, 이른바 불안정하고 한물 간 구식 기술이지만 저렴하며 프리티어를 사용하면 무료로 사용할 수 있습니다.</p>\n<br>\n<p><strong>사용 방법</strong></p>\n<ul>\n<li>EC2 설정</li>\n</ul>\n<ol>\n<li>EC2 > 인스턴스 > 인스턴스 시작</li>\n<li>생성 옵션 설정\n<ul>\n<li>Application and OS Images (Amazon Machine Image)\n<ul>\n<li>EC2 인스턴스를 시작하는 데 사용되며, 운영 체제(OS), 애플리케이션 서버 및 애플리케이션과 같은 소프트웨어가 미리 구성되어 있습니다.</li>\n<li>NAT Instance로 사용할 것이므로 NAT를 검색하여 프리 티어 사용 가능한 AMI를 선택합니다.</li>\n</ul>\n</li>\n<li>프리티어 사용 가능\n<ul>\n<li>일정한 제한된 사용량에 대해서 무료로 제공</li>\n</ul>\n</li>\n<li>키 페어(Key Pair)\n<ul>\n<li>보안상의 목적으로 사용되는 한 쌍의 암호화 키</li>\n</ul>\n</li>\n<li>스토리지 구성\n<ul>\n<li>SSD 기반은 빠르지만 고비용이고 HDD는 저렴하지만 SSD에 비해 읽기/쓰기 속도가 느림</li>\n<li>본인은 저렴한 HDD 기반의 standard(Magnetic) 선택</li>\n</ul>\n</li>\n<li>고급 세부 정보\n<ul>\n<li>많은 경우, 기본 설정만으로도 EC2 인스턴스를 충분히 구동하고 관리할 수 있습니다. 특별한 설정이나 구성이 필요하지 않다면 고급 세부 정보를 변경하지 않아도 됩니다.</li>\n<li>고급 세부 정보는 보다 세부적인 설정이 필요한 숙련된 사용자나 특정 요구 사항이 있는 경우에 유용합니다. 예를 들어, 특정 소프트웨어를 자동으로 설치하려면 사용자 데이터를 설정할 수 있습니다.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>인스턴스 생성 후 선택 > 작업 > 네트워킹 > 소스/대상 확인변경 중지\n<ul>\n<li>일반적으로, AWS에서 실행되는 각 EC2 인스턴스는 ‘소스/대상 검사(Source/Destination Check)’ 기능이 활성화되어 있습니다.</li>\n<li>이 기능은 인스턴스가 받거나 보내는 트래픽이 해당 인스턴스를 목적지나 출발지로 하는지를 확인합니다. 즉, 인스턴스는 자신이 최종 목적지나 출발점인 트래픽만 처리합니다.</li>\n<li>하지만, NAT 인스턴스의 경우 이 동작이 적합하지 않습니다. NAT 인스턴스는 다른 인스턴스의 트래픽을 인터넷으로 중계하는 역할을 하기 때문에, 자신이 트래픽의 최종 목적지나 출발점이 아닌 경우에도 트래픽을 수신하고 전송할 수 있어야 합니다.</li>\n</ul>\n</li>\n<li>탄력적 IP > 탄력적 IP 주소 할당 > 나머지 냅두고 태그: 키 Name, 값 NAT-coopangpl</li>\n<li>탄력적 주소 선택 후 작업 > 탄력적 IP 주소 연결 > NAT Instance 연결\n<ul>\n<li>탄력적 IP는 AWS 클라우드 환경에서 고정된 공용 IP 주소를 제공합니다. 이를 통해 인터넷에서 일관된 주소를 사용하여 인스턴스에 접근할 수 있습니다.</li>\n</ul>\n</li>\n<li>VPC > 라우팅 테이블 > 라우팅 테이블 생성 > 대상: 0.0.0.0/0, 인스턴스 아까 만든 NAT Instance</li>\n<li>서브넷이 총 4개가 있는데 2개는 internet gateway 라우팅 테이블에 연결, 2개는 NAT Instance에 연결된 서브넷에 연결합니다.</li>\n<li>그 후 lambda 함수를 NAT Instance에 연결된 서브넷으로 지정하면 외부 api 호출이 가능합니다.</li>\n</ol>\n<div id=\"Amazon EventBridge\"></div>\n<h2>Amazon EventBridge</h2>\n<p>Amazon EventBridge는 AWS에서 제공하는 서버리스 이벤트 버스 서비스로, 다양한 소스에서 발생하는 이벤트를 감지하거나 원하는 실행 일정을 정하면, 그에 따라 AWS 서비스, 사용자가 정의한 로직, 또는 서드파티 애플리케이션에 자동으로 반응할 수 있도록 돕습니다.</p>\n<br>\n<p>이제 모든 준비를 마쳤으니, Amazon EventBridge를 통해 원하는 시간마다 aws Lambda 함수가 실행되게 설정해봅시다.</p>\n<br>\n<p><strong>사용 방법</strong></p>\n<br>\n<p>Amazon EventBridge > 일정 > 일정 생성으로 가서 일정 세부 정보 지정을 입력합니다.</p>\n<br>\n<p>본 프로젝트에서는 매일 오전 10시 15분에 실행되게 하므로 Cron 표현식을 “15 10 * * ? *“로 입력합니다.</p>\n<br>\n<p>다음으로는 대상 선택을 합니다. aws lambda 함수를 실행시킬 것 이므로 모든 api > aws lambda > invoke > 실행할 함수 선택한 뒤 나머지 입력한 후 일정을 생성합니다.</p>\n<div id=\"과금 피하기\"></div>\n<h2>과금 피하기</h2>\n<img style=\"width: 100%; margin-bottom: 40px;\" id=\"output\" src=\"/story/7b0ad065a78c56c9347e3850296a6f7a/money.png\">\n<p>한달을 이용해본 결과 과금이 되었습니다!!ㅠㅠ</p>\n<br>\n<p>과금이 된 이유는 RDS 프리티어로 사용해도 실행 가능한 시간을 넘으면 과금된 것이었습니다.</p>\n<br>\n<p>제가 RDS를 이용하는 것은 단순히 하루에 한번 DB에 저장하기 위해서인데 쓸데없이 하루 종일 실행시켜둔 것이었습니다. 아까운 내 3만원ㅠㅠ</p>\n<br>\n<p>그래서 이를 해결하기 위해 AWS Lambda를 통해 사용하지 않을 때는 Instance 및 RDS 자동 중지 및 시작하려고 합니다.</p>\n<br>\n<p>실행 코드</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import boto3\r\n\r\nregion = 'ap-northeast-2'\r\ninstances = []\r\nec2_r = boto3.resource('ec2')\r\nec2 = boto3.client('ec2', region_name=region)\r\nrds = boto3.client('rds')\r\n\r\nfor instance in ec2_r.instances.all():\r\n    if instance.state['Name'] == 'stopped':\r\n        for tag in instance.tags:\r\n            if tag['Key'] == 'auto-start':\r\n                if tag['Value'] == 'true':\r\n                    instances.append(instance.id)\r\n\r\ndef lambda_handler(event, context):\r\n    if len(instances) == 0:\r\n        print('instance not found')\r\n    else:\r\n        ec2.start_instances(InstanceIds=instances)\r\n        print('start your instances: ' + str(instances))\r\n        \r\n    dbs = rds.describe_db_instances()\r\n    for db in dbs['DBInstances']:\r\n        if (db['DBInstanceStatus'] == 'stopped'):\r\n            doNotStart=1\r\n            try:\r\n                GetTags=rds.list_tags_for_resource(ResourceName=db['DBInstanceArn'])['TagList']\r\n                for tags in GetTags:\r\n                    if(tags['Key'] == 'auto-start' and tags['Value'] == 'true'):\r\n                        result = rds.start_db_instance(DBInstanceIdentifier=db['DBInstanceIdentifier'])\r\n                        print (\"Starting instance: {0}.\".format(db['DBInstanceIdentifier']))\r\n                if(doNotStart == 1):\r\n                    doNotStart=1\r\n            except Exception as e:\r\n                print (\"Cannot start instance {0}.\".format(db['DBInstanceIdentifier']))\r\n                print(e)</code></pre></div>\n<p>중지 코드</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">import boto3\r\n\r\nregion = 'ap-northeast-2'\r\ninstances = []\r\nec2_r = boto3.resource('ec2')\r\nec2 = boto3.client('ec2', region_name=region)\r\nrds = boto3.client('rds')\r\n\r\nfor instance in ec2_r.instances.all():\r\n    if instance.state['Name'] == 'running':\r\n        for tag in instance.tags:\r\n            if tag['Key'] == 'auto-stop':\r\n                if tag['Value'] == 'true':\r\n                    instances.append(instance.id)\r\n\r\ndef lambda_handler(event, context):\r\n    if len(instances) == 0:\r\n        print('instance not found')\r\n    else:\r\n        ec2.stop_instances(InstanceIds=instances)\r\n        print('stopped your instances: ' + str(instances))\r\n        \r\n    dbs = rds.describe_db_instances()\r\n    for db in dbs['DBInstances']:\r\n        if (db['DBInstanceStatus'] == 'available'):\r\n            DoNotStop=1\r\n            try:\r\n                GetTags=rds.list_tags_for_resource(ResourceName=db['DBInstanceArn'])['TagList']\r\n                for tags in GetTags:\r\n                    if(tags['Key'] == 'auto-stop' and tags['Value'] == 'true'):\r\n                        result = rds.stop_db_instance(DBInstanceIdentifier=db['DBInstanceIdentifier'])\r\n                        print (\"Stopping instance: {0}.\".format(db['DBInstanceIdentifier']))\r\n                if(DoNotStop == 1):\r\n                    DoNotStop=1\r\n            except Exception as e:\r\n                print (\"Cannot stop instance {0}.\".format(db['DBInstanceIdentifier']))\r\n                print(e)</code></pre></div>\n<p>하지만 코드를 실행시키기 위해서는 EC2 Instance와 RDS를 변경할 권한이 있어야 합니다.</p>\n<br>\n<p>구성 > 권한 > 역할 이름을 클릭 > 정책 이름 클릭 > JSON > 편집</p>\n<br>\n<p>실행 권한</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\r\n    \"Version\": \"2012-10-17\",\r\n    \"Statement\": [\r\n        {\r\n            \"Sid\": \"start\",\r\n            \"Effect\": \"Allow\",\r\n            \"Action\": [\r\n                \"ec2:StartInstances\",\r\n                \"rds:StartDBCluster\",\r\n                \"rds:StartDBInstance\"\r\n            ],\r\n            \"Resource\": [\r\n                \"arn:aws:rds:*:*:db:*\",\r\n                \"arn:aws:ec2:*:*:instance/*\"\r\n            ]\r\n        },\r\n        {\r\n            \"Sid\": \"describe\",\r\n            \"Effect\": \"Allow\",\r\n            \"Action\": [\r\n                \"ec2:DescribeInstances\",\r\n                \"ec2:DescribeTags\",\r\n                \"ec2:DescribeInstanceStatus\",\r\n                \"rds:ListTagsForResource\",\r\n                \"rds:DescribeDBInstances\",\r\n                \"rds:DescribeDBClusters\"\r\n            ],\r\n            \"Resource\": \"*\"\r\n        }\r\n    ]\r\n}</code></pre></div>\n<p>중지 권한</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\r\n    \"Version\": \"2012-10-17\",\r\n    \"Statement\": [\r\n        {\r\n            \"Sid\": \"stop\",\r\n            \"Effect\": \"Allow\",\r\n            \"Action\": [\r\n                \"ec2:StopInstances\",\r\n                \"ec2:DescribeInstances\",\r\n                \"ec2:DescribeTags\",\r\n                \"ec2:DescribeInstanceStatus\",\r\n                \"rds:StopDBCluster\",\r\n                \"rds:ListTagsForResource\",\r\n                \"rds:DescribeDBInstances\",\r\n                \"rds:StopDBInstance\",\r\n                \"rds:DescribeDBClusters\"\r\n            ],\r\n            \"Resource\": \"*\"\r\n        }\r\n    ]\r\n}</code></pre></div>\n<p>이제 해당 EC2 Instance와 RDS의 태그에서 key: auto-start, auto-stop을 true로 추가한다.</p>\n<br>\n<p>이제 마지막으로 Lambda의 트리거 추가에서 EventBridge를 선택하여 원하는 시간이 함수가 실행되도록 한다.</p>\n<br>\n<p>여기서 주의할 점은 Lambda의 트리거 추가에서 시간은 UTC 기준이므로 현지 시간 기준을 잘 살펴야한다!!</p>\n<br>\n<p><a href=\"https://sonit.tistory.com/19\" target=\"_blank\" rel=\"nofollow\">참고</a></p>","frontmatter":{"title":"일정시간이 되면 서버에서 자동으로 api를 호출하고 db에 저장하는 방법","summary":"aws Lambda, s3, EventBridge, RDS, EC2, NAT Instance를 사용해보자.","date":"2023.02.16.","categories":["WEB/APP"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEZklEQVR42j2TCU8bVxDH9wNUvRRE1IQkrTh87PpcY0OIACGaqmoKSJFCA4ratFVDOJoAbShpEVcSEQg4YByccBgaKBgM5rC963O959tdr20gBkSq9qv0EaRKT6N5evrp/5+ZN0j151/gRo0Vx8pseJnNbMP1Zr3GgBah6nyLCRsbs8di8VA4Go8nGJbnOEEQRAAkUZRhRCoqq2zFeiuOXraZS63GElxvMWiMmArV5BebsOf28TiViERiFEWfwjwPIC8ACSZISemV8itWo05lxQ3FZoNRrzWgapNOhUHYiI2POyAWjsTiFE1DmAenMDiFTSa8orxMpy2wmPTwGHVaVF2IaQpObBsxh2Pyf5h5B5/IChKMMEdQFCsrK1UXfWrUo2YDZtBpMG2RujBfq8rHT5THw+FIMBiCPJVgGIZjT8zzLMsmEjSiRXUohkKdYrPOYkRNek1RwaWi/M8uXcgzYWr7mH17eydEkhRFwXJFIAABqvMCz8WiEaSgUGOx4MUmFLbKgKrOnc358P33Pv7og/qaamF7WiCXiIA/CYS0LO0qyTeZdHYvc/hmL7ub5hNxJCc3r6KiHJrMO/cJqtXU1V7Lzc2xGlS+lwNLjgHfVN/KrDOTlAHLSDwn8pzEswoQUiIPr8iZM2fP513EcUtHZ/uGz3twuLeyvDjy8M7wr9+vTo8+aPlpYqj/aD8jMicwJNl4TEhQgGFiIRIxmS0XLhY8HHgKW5g9SO1m0qzknbf/3Hnr676OHwf/6PK4XUf7u1AqKfApwAMmARg6Hg75N31IZWXVjMsVIYJPno5u7mylFMGx0vR7X03r9er6St3zwVY6sg3JjAwykrCXFCHPURSXoOhoGKmtrYuQ/sNdJSPxrlevJhc7+53XG1v1N25it78z9A7WhcitKOGPEH7YIeVEmYLOZY6TORZpbm4Ok8FEggGi4vP5Oga+bH9c9e09w602rKnb+EvvtUAgGCLDm+veTe9KIhKiwmQkGIiHSBqOqqfnt/U1D8tJHJBpGnTea+gaqW5o0TXexWpuFH5z2wp/JMXKKx7v0p/uDc/Sltez5V3bXl+DCdLa0rSxuhwORYGcTqWzronH3aNXq2vUZlxVbCv4qh4jAuubo22+sVbvutc9O/vaPTczNbkw8/KvBTdSWVG+uvya8O/EKfbg8B8yTtzts/3QdrXxZr21RFNaef5+c0N7jXlu6AHD8AQZDRDheffC2PCQffgJXAzLYF+P17M8NzMN32iWcb5sn50f8a77Rp4NdXfcmbA/o1hp/+BvJbXLC7Isp3leJoio68UUYrRchiJOx/j87PTc9DTgBZFYySip/ezx4dHb47f/Zg+OFSUtAjkJByKl4Eq922qJoQHS2fXIpNfdb2ueck5srHpIMsrxopLa298/lJNpUUrCvYUxmcyIkgITjoO/i4MlxKI04l5YLbfqK0pMj/p7XzgmXE7n/MIiw0IgJQBoUpEkBQA4V8BxIsuJ8ImiGJKIbG36/wPG3qQZ7mlVkwAAAABJRU5ErkJggg=="},"images":{"fallback":{"src":"/story/static/3672896cbb49cb2a4050c9744a3e8496/d89b0/test.jpg","srcSet":"/story/static/3672896cbb49cb2a4050c9744a3e8496/aaa13/test.jpg 374w,\n/story/static/3672896cbb49cb2a4050c9744a3e8496/b3c6b/test.jpg 748w,\n/story/static/3672896cbb49cb2a4050c9744a3e8496/d89b0/test.jpg 1496w","sizes":"(min-width: 1496px) 1496px, 100vw"},"sources":[{"srcSet":"/story/static/3672896cbb49cb2a4050c9744a3e8496/0dfd6/test.webp 374w,\n/story/static/3672896cbb49cb2a4050c9744a3e8496/8acfa/test.webp 748w,\n/story/static/3672896cbb49cb2a4050c9744a3e8496/06565/test.webp 1496w","type":"image/webp","sizes":"(min-width: 1496px) 1496px, 100vw"}]},"width":1496,"height":1496}},"publicURL":"/story/static/3672896cbb49cb2a4050c9744a3e8496/test.png"}}}}]}},"pageContext":{"slug":"/asw Lambda 사용방법/"}},"staticQueryHashes":[],"slicesMap":{}}